#!/usr/bin/env node
/**
 * One-time script to generate PLZ-to-Bundesland and City-to-Bundesland lookup tables.
 * Source: OpenPLZ API (https://openplzapi.org)
 *
 * Usage: node scripts/generate-plz-data.mjs
 * Output: supabase/functions/_shared/plz-data.ts
 */

import { writeFileSync } from "node:fs";
import { resolve, dirname } from "node:path";
import { fileURLToPath } from "node:url";

const __dirname = dirname(fileURLToPath(import.meta.url));
const OUTPUT_PATH = resolve(__dirname, "../supabase/functions/_shared/plz-data.ts");

const PAGE_SIZE = 50;

async function fetchAllRecords() {
  const records = [];
  let page = 1;
  const seenPlz = new Set();

  console.log("Fetching PLZ data from OpenPLZ API...");

  // The API returns all German localities when using a broad wildcard like "0*"
  // We paginate through the full dataset
  while (true) {
    const url = `https://openplzapi.org/de/Localities?postalCode=0*&page=${page}&pageSize=${PAGE_SIZE}`;
    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`API error ${resp.status} on page ${page}`);

    const data = await resp.json();
    if (!Array.isArray(data) || data.length === 0) break;

    // Deduplicate by PLZ+name
    for (const rec of data) {
      const key = `${rec.postalCode}|${rec.name}`;
      if (!seenPlz.has(key)) {
        seenPlz.add(key);
        records.push(rec);
      }
    }

    page++;
    if (page % 20 === 0) {
      process.stdout.write(`\r  Page ${page}, unique records: ${records.length}`);
    }

    // Brief delay to be polite
    await new Promise((r) => setTimeout(r, 30));
  }

  console.log(`\n  Done fetching: ${records.length} unique records across ${page - 1} pages.`);
  return records;
}

function buildLookups(records) {
  const plzToState = {};
  const cityEntries = new Map(); // cityLower -> Set<bundesland>

  for (const rec of records) {
    const plz = rec.postalCode;
    const cityName = rec.name;
    const stateName = rec.federalState?.name;

    if (!plz || !stateName) continue;

    // PLZ -> Bundesland
    plzToState[plz] = stateName;

    // City -> Bundesland (collect all states per city name for ambiguity detection)
    if (cityName) {
      const cityLower = cityName.trim().toLowerCase();
      if (!cityEntries.has(cityLower)) {
        cityEntries.set(cityLower, new Set());
      }
      cityEntries.get(cityLower).add(stateName);
    }
  }

  // Build city-to-state, excluding ambiguous cities (same name in multiple states)
  const cityToState = {};
  let ambiguousCount = 0;
  for (const [city, states] of cityEntries) {
    if (states.size === 1) {
      cityToState[city] = [...states][0];
    } else {
      ambiguousCount++;
    }
  }

  console.log(`  PLZ entries: ${Object.keys(plzToState).length}`);
  console.log(`  Unique city entries: ${Object.keys(cityToState).length}`);
  console.log(`  Ambiguous cities excluded: ${ambiguousCount}`);

  return { plzToState, cityToState };
}

// Foreign cities commonly seen in medical job postings
const FOREIGN_CITIES = {
  // Austria
  graz: "Österreich",
  villach: "Österreich",
  wien: "Österreich",
  salzburg: "Österreich",
  innsbruck: "Österreich",
  linz: "Österreich",
  klagenfurt: "Österreich",
  "klagenfurt am wörthersee": "Österreich",
  wels: "Österreich",
  "st. pölten": "Österreich",
  dornbirn: "Österreich",
  feldkirch: "Österreich",
  bregenz: "Österreich",
  wolfsberg: "Österreich",
  leoben: "Österreich",
  steyr: "Österreich",
  hallein: "Österreich",
  "bad ischl": "Österreich",
  // Switzerland
  luzern: "Schweiz",
  kriens: "Schweiz",
  zürich: "Schweiz",
  bern: "Schweiz",
  basel: "Schweiz",
  genf: "Schweiz",
  lausanne: "Schweiz",
  winterthur: "Schweiz",
  "st. gallen": "Schweiz",
  aarau: "Schweiz",
  schaffhausen: "Schweiz",
  chur: "Schweiz",
  lugano: "Schweiz",
  sarnen: "Schweiz",
  recherswil: "Schweiz",
};

// Manual overrides for clinic names, ambiguous cities, and edge cases
const CLINIC_OVERRIDES = {
  "diakovere krankenhaus ggmbh": "Niedersachsen",
  "diakovere krankenhaus ggmbh - schwemannstraße": "Niedersachsen",
  "dr. becker burg-klinik, dermbach": "Thüringen",
  "dr. becker klinik möhnesee": "Nordrhein-Westfalen",
  "dillingen an der donau": "Bayern",
  "ellwangen": "Baden-Württemberg",
  "freudenberg": "Nordrhein-Westfalen",
  "kirchen": "Rheinland-Pfalz",
  "kremnitzaue": "Sachsen-Anhalt",
  "lichtenfels": "Bayern",
};

function generateTypeScript(plzToState, cityToState) {
  const sortedPlz = Object.keys(plzToState).sort();
  const sortedCities = Object.keys(cityToState).sort();

  let ts = `// Auto-generated by scripts/generate-plz-data.mjs
// Source: OpenPLZ API (https://openplzapi.org)
// Do not edit manually — re-run the generator script instead.

/** 5-digit PLZ → Bundesland (${sortedPlz.length} entries) */
export const PLZ_TO_STATE: Record<string, string> = {\n`;

  for (const plz of sortedPlz) {
    ts += `  "${plz}": "${plzToState[plz]}",\n`;
  }
  ts += "};\n\n";

  ts += `/** Lowercase city name → Bundesland (${sortedCities.length} entries, ambiguous names excluded) */
export const CITY_TO_STATE: Record<string, string> = {\n`;

  for (const city of sortedCities) {
    const escaped = city.replace(/\\/g, "\\\\").replace(/"/g, '\\"');
    ts += `  "${escaped}": "${cityToState[city]}",\n`;
  }
  ts += "};\n\n";

  ts += `/** Foreign cities commonly seen in medical job postings */
export const FOREIGN_CITIES: Record<string, string> = {\n`;
  for (const [city, country] of Object.entries(FOREIGN_CITIES)) {
    ts += `  "${city}": "${country}",\n`;
  }
  ts += "};\n\n";

  ts += `/** Known clinic/facility name overrides */
export const CLINIC_OVERRIDES: Record<string, string> = {\n`;
  for (const [name, state] of Object.entries(CLINIC_OVERRIDES)) {
    ts += `  "${name}": "${state}",\n`;
  }
  ts += "};\n";

  return ts;
}

async function main() {
  try {
    const records = await fetchAllRecords();
    const { plzToState, cityToState } = buildLookups(records);
    const ts = generateTypeScript(plzToState, cityToState);

    writeFileSync(OUTPUT_PATH, ts, "utf-8");
    console.log(`\nWritten to ${OUTPUT_PATH}`);
    console.log(`File size: ${(Buffer.byteLength(ts) / 1024).toFixed(1)} KB`);
  } catch (err) {
    console.error("Error:", err.message);
    process.exit(1);
  }
}

main();
